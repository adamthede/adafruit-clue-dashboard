<!DOCTYPE html>
<html>
<head>
    <title>CLUE Gateway</title>
    <meta charset="utf-8">
    <!-- Include Chart.js library from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>


    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f0f0f0; }
        .main-content { display: flex; flex-grow: 1; min-height: 0; /* Needed for flex-grow in flex column */}
        .left-panel { display: flex; flex-direction: column; width: 450px; padding: 10px; border-right: 1px solid #ccc; background-color: #fff; }
        .right-panel { flex-grow: 1; padding: 10px; display: flex; flex-direction: column; background-color: #fff;}

        .controls { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;}
        .controls div { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .controls label { margin-right: 5px; min-width: 80px; text-align: right;}
        .controls select { min-width: 250px; padding: 5px; flex-grow: 1;}
        .controls input[type=number] { width: 60px; padding: 5px;}
        .controls button { padding: 5px 10px; cursor: pointer; }

        .log-area-container { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; /* Ensure container can shrink */ }
        .log-area { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; background-color: #fdfdfd; font-family: monospace; white-space: pre-wrap; font-size: 0.9em; padding: 5px; margin-top: 5px; }
        .log-area p { margin: 0 0 3px 0; padding: 0; line-height: 1.3; }
        .log-area .info { color: black; }
        .log-area .debug { color: grey; }
        .log-area .warn { color: orange; }
        .log-area .error { color: red; font-weight: bold; }

        .chart-container { position: relative; height: 90%; width: 100%; /* Adjust height as needed */ }

        .status-bar {
             padding: 5px 15px;
             background-color: #eee;
             border-top: 1px solid #ccc;
             font-size: 0.9em;
             margin-top: 10px;
             display: flex; /* Use flexbox for status and timer */
             justify-content: space-between; /* Space out status and timer */
             align-items: center;
        }
        .status-bar.info { background-color: #eee; color: black;}
        .status-bar.success { background-color: lightgreen; color: darkgreen;}
        .status-bar.error { background-color: lightcoral; color: darkred;}
        .status-bar.warn { background-color: lightyellow; color: orange;}
        #countdown-display {
             font-style: italic;
             color: #555;
        }
        .time-range-selector { /* Style for the new div */
             margin-top: 10px;
             padding-top: 10px;
             border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="left-panel">
            <div class="controls">
                <div>
                    <label for="port-select">Serial Port:</label>
                    <select id="port-select"></select>
                    <button id="refresh-btn">Refresh</button>
                </div>
                 <div class="time-range-selector" id="time-range-selector">
                    <label for="time-range-select">Load History:</label>
                    <select id="time-range-select">
                        <option value="1h" selected>Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="all">All Available</option>
                     </select>
                 </div>
                 <div>
                     <label> </label> <!-- Spacer -->
                    <button id="connect-btn">Connect</button>
                    <button id="disconnect-btn" disabled>Disconnect</button>
                 </div>
                 <div id="interval-control" style="display: none;"> <!-- Hide initially -->
                     <label for="interval-input">Capture Interval (s):</label>
                     <input type="number" id="interval-input" value="30" min="1">
                     <button id="set-interval-btn">Set Interval</button>
                 </div>
            </div>

            <!-- Add Export Buttons -->
            <div class="export-controls" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-around;">
                <button id="export-chart-btn">Export Chart Data</button>
                <button id="export-all-btn">Export All History</button>
            </div>
            <!-- End Export Buttons -->

            <div class="log-area-container">
                <label>Log & Sensor Data:</label>
                <div class="log-area" id="log-area">
                    <p class="info">App started. Select history range and port, then connect.</p>
                </div>
            </div>
             <div class="status-bar info" id="status-bar">
                <span id="status-text">Status: Disconnected</span>
                <!-- Add AIO Status Span -->
                <span id="aio-status-display" style="margin-left: 15px; font-style: italic; color: #555;">
                    AIO: <span id="aio-status-text">Unknown</span>
                </span>
             </div>
        </div>

        <div class="right-panel">
            <label>Live Data Chart:</label>
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>

            <!-- Add Data Table Section -->
            <div class="table-container" style="margin-top: 20px; height: 200px; overflow-y: auto; border-top: 1px solid #ccc; padding-top: 10px;">
                <label>Recent Readings:</label>
                <table id="data-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid #ddd;">
                            <th>Timestamp</th>
                            <th>Temp (Â°F)</th>
                            <th>Humidity (%)</th>
                            <th>Pressure (hPa)</th>
                            <th>Light</th>
                            <th>Sound</th>
                            <th>Color</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Rows will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- End Data Table Section -->

        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>